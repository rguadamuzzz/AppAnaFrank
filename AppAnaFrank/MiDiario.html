<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Diario Personal</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Archivo CSS personalizado -->
    <link rel="stylesheet" href="MiDiario.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm fw-bold">
    <img src="img/logo_ana_frank-removebg-preview.png" href="inicio.html" alt="Logo" width="40" height="40" class="d-inline-block align-text-top ms-4">
    
    <a class="navbar-brand font-weight-bold" href="inicio.html">Querida Kitty</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <div class="navbar-nav ml-5">
        <a class="nav-item nav-link active" href="inicio.html">Inicio</a>
        <a class="nav-item nav-link" href="#">Mi Diario</a>
        <a class="nav-item nav-link" href="#">Explora</a>
        <a class="nav-item nav-link" href="#">Historia Viva</a>
        <a class="nav-item nav-link" href="equipo.html">Amigas de Ana Frank</a>
      </div>
    </div>
  </nav>
 
  <head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>


  <script>
    const toggle = document.querySelector(".menu-toggle");
    const navLinks = document.querySelector(".nav-links");

    toggle.addEventListener("click", () => {
      navLinks.classList.toggle("active");
    });
  </script>

    <script src="https://cdn.jsdelivzr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>



    <div class="main-container container-fluid my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-lg">
                    <div class="card-header">
                        <h1 class="h3 mb-1">Mi Diario Personal</h1>
                        <p class="mb-0 fs-6">Un espacio para tus pensamientos...</p>
                    </div>
                    <div class="card-body">
                        <form id="diaryForm">
                            <input type="hidden" id="entryId">
                            <div class="mb-4">
                                <label for="diaryEntry" class="form-label text-muted">¬øQu√© hay en tu coraz√≥n hoy?</label>
                                <p class="lead" id="emotionPrompt">Elige una emoci√≥n para tu entrada...</p>
                                <div class="emotion-selector" id="emotionSelector">
                                    <button type="button" class="emotion-btn" data-emotion="alegre" data-emoji="üòä" aria-label="Emoci√≥n: Feliz">
                                        üòä<br><span class="emotion-label">Feliz</span>
                                    </button>
                                    <button type="button" class="emotion-btn" data-emotion="triste" data-emoji="üò•" aria-label="Emoci√≥n: Triste">
                                        üò•<br><span class="emotion-label">Triste</span>
                                    </button>
                                    <button type="button" class="emotion-btn" data-emotion="enojado" data-emoji="üò°" aria-label="Emoci√≥n: Enojado">
                                        üò°<br><span class="emotion-label">Enojado</span>
                                    </button>
                                    <button type="button" class="emotion-btn" data-emotion="sorprendido" data-emoji="üò≤" aria-label="Emoci√≥n: Sorprendido">
                                        üò≤<br><span class="emotion-label">Sorprendido</span>
                                    </button>
                                    <button type="button" class="emotion-btn" data-emotion="gratitud" data-emoji="üòå" aria-label="Emoci√≥n: Calmado">
                                        ü•∞<br><span class="emotion-label">Gratitud</span>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label text-muted">Inspiraci√≥n (haz clic en una para empezar)</label>
                                <div class="prompt-container" id="promptContainer">
                                    <button type="button" class="prompt-btn" data-prompt="¬øQu√© te dio esperanza hoy?">¬øQu√© te dio esperanza hoy?</button>
                                    <button type="button" class="prompt-btn" data-prompt="¬øA qu√© injusticia dijiste ‚Äòno‚Äô?">¬øA qu√© injusticia dijiste ‚Äòno‚Äô?</button>
                                    <button type="button" class="prompt-btn" data-prompt="Si pudieras escribirle a tu ‚Äòyo‚Äô de dentro de un a√±o, ¬øqu√© dir√≠as?">Escribe a tu ‚Äòyo‚Äô del futuro.</button>
                                    <button type="button" class="prompt-btn" data-prompt="¬øQu√© acto de amabilidad recibiste hoy?">¬øQu√© acto de amabilidad recibiste?</button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <p class="mb-1 text-muted d-none" id="writingMessage">‚úçÔ∏è Tu voz importa.</p>
                                <textarea class="form-control" id="diaryEntry" rows="10" placeholder="Querido diario..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">C√≥mo quieres guardar tu entrada</label>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <input class="btn-check" type="radio" name="mode" id="modePublic" value="public" checked>
                                        <label class="btn btn-outline-dark w-100" for="modePublic">Mural an√≥nimo</label>
                                    </div>
                                    <div class="col-md-6">
                                        <input class="btn-check" type="radio" name="mode" id="modeTimeCapsule" value="capsule">
                                        <label class="btn btn-outline-dark w-100" for="modeTimeCapsule">C√°psula del tiempo</label>
                                    </div>
                                </div>

                                <div id="capsuleDateWrap" class="mt-2 d-none">
                                    <label class="form-label">Abrir el:</label>
                                    <input type="date" id="capsuleDate" class="form-control" />
                                </div>

                                <div class="form-text mt-2">
                                    Publicaremos an√≥nimamente. No compartas datos personales.
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <span id="rateLimitMessage" class="rate-limit-message d-none">Gracias por compartir. Espera un minuto antes de otra entrada.</span>
                                <button type="submit" class="btn btn-custom" id="submitBtn">
                                    <span id="submitBtnText">Compartir</span>
                                    <span id="submitBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                </button>
                            </div>
                        </form>
                        
                        <hr class="my-5">
                        
                        <h2 class="h4 text-center mb-4">Ecos de la Comunidad (<span id="entryCount">0</span>)</h2>
                        <div id="diaryEntriesContainer" aria-live="polite">
                            <div class="loading-spinner">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    ¬øEst√°s seguro de que quieres eliminar esta entrada? Esta acci√≥n es irreversible.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth ---
        if (!firebaseConfig) {
            console.error("Firebase config is missing. App cannot be initialized.");
        }

        const app = firebaseConfig ? initializeApp(firebaseConfig) : null;
        const db = app ? getFirestore(app) : null;
        const auth = app ? getAuth(app) : null;
        let userId = null;
        
        const nicknameMap = {
            'alegre': 'Alma Alegre',
            'triste': 'Coraz√≥n Melanc√≥lico',
            'enojado': 'Coraz√≥n Indignado',
            'sorprendido': 'Esp√≠ritu Sorprendido',
            'calmado': 'Mente Serena',
            'default': 'Narrador An√≥nimo'
        };

        const emotionEmojiMap = {
            'alegre': 'üòä',
            'triste': 'üò•',
            'enojado': 'üò°',
            'sorprendido': 'üò≤',
            'calmado': 'üòå'
        };

        const adjectives = ['Alma', 'Coraz√≥n', 'Esp√≠ritu', 'Mente', 'Voz', '√Årbol', 'R√≠o', 'Sol', 'Luna', 'Estrella', 'Flor'];
        const nouns = ['Sonora', 'Sereno', 'Claro', 'Radiante', 'Silencioso', 'Libre', 'Valiente', 'Sabio', 'Curioso', 'Amable', 'Puro'];

        function generatePseudonym() {
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            return `${adj} ${noun}`;
        }
        
        // --- PII Sanitization Function ---
        function sanitizePII(text){
            // emails
            text = text.replace(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi,'[email oculto]');
            // tel√©fonos (varios formatos b√°sicos)
            text = text.replace(/(\+?\d{1,3})?[\s.-]?\(?\d{2,4}\)?[\s.-]?\d{3,4}[\s.-]?\d{3,4}/g,'[tel√©fono oculto]');
            // @handles
            text = text.replace(/@\w{2,30}/g,'[@usuario]');
            // direcciones simples (muy conservador)
            text = text.replace(/\b(calle|av\.?|avenida|#|n¬∞|no\.)\s?[^\n,]{3,}/gi,'[direcci√≥n omitida]');
            return text;
        }


        // Get DOM elements
        const form = document.getElementById('diaryForm');
        const entryTextarea = document.getElementById('diaryEntry');
        const entriesContainer = document.getElementById('diaryEntriesContainer');
        const entryCountDisplay = document.getElementById('entryCount');
        const submitBtn = document.getElementById('submitBtn');
        const submitBtnText = document.getElementById('submitBtnText');
        const submitBtnSpinner = document.getElementById('submitBtnSpinner');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const emotionSelector = document.getElementById('emotionSelector');
        const emotionPrompt = document.getElementById('emotionPrompt');
        const promptContainer = document.getElementById('promptContainer');
        const writingMessage = document.getElementById('writingMessage');
        const rateLimitMessage = document.getElementById('rateLimitMessage');
        const modeRadios = document.querySelectorAll('input[name="mode"]');
        const capsuleWrap = document.getElementById('capsuleDateWrap');
        const capsuleDate = document.getElementById('capsuleDate');


        let entryToDeleteId = null;
        let selectedEmotion = null;
        let lastSubmit = 0;
        
        // --- Event Listeners for UI ---
        
        // Toggle time capsule date input
        modeRadios.forEach(r => r.addEventListener('change', () => {
            capsuleWrap.classList.toggle('d-none', r.id !== 'modeTimeCapsule' || !r.checked);
        }));

        emotionSelector.addEventListener('click', (e) => {
            const button = e.target.closest('.emotion-btn');
            if (!button) return;

            // Remove 'selected' class from all buttons
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));

            // Add 'selected' class to the clicked button
            button.classList.add('selected');
            selectedEmotion = button.dataset.emotion;
            emotionPrompt.textContent = `Has elegido: ${button.querySelector('.emotion-label').textContent}. ¬°Adelante!`;
        });
        
        promptContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.prompt-btn');
            if (!button) return;
            entryTextarea.value = button.dataset.prompt + '\n\n';
            entryTextarea.focus();
        });
        
        entryTextarea.addEventListener('input', () => {
            if (entryTextarea.value.length > 0) {
                writingMessage.classList.remove('d-none');
            } else {
                writingMessage.classList.add('d-none');
            }
        });

        // --- Autosave and Restore Draft ---
        setInterval(() => {
            const draft = entryTextarea.value;
            if (draft) {
                localStorage.setItem('draft_entry', draft);
            } else {
                localStorage.removeItem('draft_entry');
            }
        }, 3000);

        const draft = localStorage.getItem('draft_entry');
        if (draft) {
            entryTextarea.value = draft;
            writingMessage.classList.remove('d-none');
        }

        // --- Firebase Initialization and Auth ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                initRealtimeListener();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase auth error:", error);
                }
            }
        });

        // --- Firestore Operations ---
        function initRealtimeListener() {
            if (!db) return;
            const q = query(collection(db, `/artifacts/${appId}/public/data/diary_entries`));

            onSnapshot(q, (snapshot) => {
                const firestoreEntries = [];
                snapshot.forEach((doc) => {
                    firestoreEntries.push({ id: doc.id, ...doc.data() });
                });
                
                const now = Date.now();
                const visibleEntries = firestoreEntries.filter(e => !e.openAt || (e.openAt.toDate() <= new Date()));
                
                // Combine local and Firestore entries for display
                const allEntries = visibleEntries;

                // Ordenar por fecha de creaci√≥n en memoria, de m√°s reciente a m√°s antigua
                allEntries.sort((a, b) => (b.createdAt?.toDate()?.getTime() || b.createdAt) - (a.createdAt?.toDate()?.getTime() || a.createdAt));

                displayEntries(allEntries);
            }, (error) => {
                console.error("Error al escuchar Firestore: ", error);
            });
        }

        async function saveEntry(content, entryId) {
            if (!db || !userId) return;
            const entriesCollection = collection(db, `/artifacts/${appId}/public/data/diary_entries`);

            submitBtn.disabled = true;
            submitBtnText.textContent = 'Guardando...';
            submitBtnSpinner.classList.remove('d-none');
            
            // PII sanitization
            content = sanitizePII(content);

            // Publication mode
            const mode = (document.querySelector('input[name="mode"]:checked')||{}).value || 'public';
            const openAt = (mode === 'capsule' && capsuleDate.value) ? new Date(capsuleDate.value) : null;

            try {
                if (entryId) {
                    const entryDocRef = doc(db, `/artifacts/${appId}/public/data/diary_entries`, entryId);
                    await updateDoc(entryDocRef, {
                        content: content,
                    });
                } else {
                    const nickname = nicknameMap[selectedEmotion] || generatePseudonym();
                    const entryData = {
                        content: content,
                        userId: userId,
                        emotion: selectedEmotion || 'default',
                        nickname: nickname,
                        createdAt: serverTimestamp(),
                        openAt: openAt,
                    };
                    await addDoc(entriesCollection, entryData);
                }
            } catch (e) {
                console.error("Error al guardar la entrada: ", e);
            } finally {
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Compartir';
                submitBtnSpinner.classList.add('d-none');
            }
        }

        async function deleteEntry(entryId) {
            if (!db) return;
            try {
                await deleteDoc(doc(db, `/artifacts/${appId}/public/data/diary_entries`, entryId));
            } catch (e) {
                console.error("Error al eliminar la entrada: ", e);
            }
        }

        // --- UI Logic ---
        function timeAgo(date) {
            if (!date) return '';
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `Hace ${Math.floor(interval)} a√±o(s)`;
            interval = seconds / 2592000;
            if (interval > 1) return `Hace ${Math.floor(interval)} mes(es)`;
            interval = seconds / 86400;
            if (interval > 1) return `Hace ${Math.floor(interval)} d√≠a(s)`;
            interval = seconds / 3600;
            if (interval > 1) return `Hace ${Math.floor(interval)} hora(s)`;
            interval = seconds / 60;
            if (interval > 1) return `Hace ${Math.floor(interval)} minuto(s)`;
            return `Hace ${Math.floor(seconds)} segundo(s)`;
        }

        function displayEntries(entries) {
            entriesContainer.innerHTML = '';
            entryCountDisplay.textContent = entries.length;

            if (entries.length === 0) {
                entriesContainer.innerHTML = '<p class="text-center text-muted">S√© la primera persona en compartir.</p>';
                return;
            }

            entries.forEach(entry => {
                const entryCard = document.createElement('div');
                entryCard.className = 'entry-card';

                const createdAtDate = entry.createdAt ? entry.createdAt.toDate() : new Date();
                const timeString = timeAgo(createdAtDate);
                const emotionEmoji = emotionEmojiMap[entry.emotion] || '';

                const isTimeCapsule = entry.openAt && entry.openAt.toDate() > new Date();
                const contentHtml = isTimeCapsule ? 'Esta entrada es una c√°psula del tiempo.' : entry.content;
                const isMyEntry = entry.userId === userId;

                entryCard.innerHTML = `
                    <div class="entry-meta">
                        <small>
                            <strong>${entry.nickname || 'An√≥nimo'}</strong>
                            <span class="text-muted">${isTimeCapsule ? '(C√°psula del tiempo)' : ''}</span>
                        </small>
                        <small>${timeString}</small>
                    </div>
                    <hr>
                    <div class="d-flex align-items-center mb-3">
                         <span class="emotion-icon">${emotionEmoji}</span>
                    </div>
                    <p>${contentHtml}</p>
                    <div class="entry-actions text-end">
                        ${isMyEntry ? `
                            <button class="btn btn-warning btn-sm edit-btn" data-id="${entry.id}">Editar</button>
                            <button class="btn btn-danger btn-sm delete-btn" data-id="${entry.id}">Eliminar</button>
                        ` : ''}
                    </div>
                `;
                entriesContainer.appendChild(entryCard);
            });
            
            // Add event listeners for edit and delete buttons using event delegation
            entriesContainer.addEventListener('click', (e) => {
                const button = e.target;
                const card = button.closest('.entry-card');
                if (!card) return;
                
                if (button.classList.contains('edit-btn')) {
                    const id = button.dataset.id;
                    const entryToEdit = entries.find(entry => entry.id === id);
                    if (entryToEdit) {
                        entryTextarea.value = entryToEdit.content;
                        form.querySelector('#entryId').value = id;
                        entryTextarea.focus();
                    }
                } else if (button.classList.contains('delete-btn')) {
                    entryToDeleteId = button.dataset.id;
                    deleteModal.show();
                }
            });
        }
        
        confirmDeleteBtn.addEventListener('click', async () => {
            if (entryToDeleteId) {
                await deleteEntry(entryToDeleteId);
                deleteModal.hide();
                entryToDeleteId = null;
            }
        });


        // --- Form Submission ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const now = Date.now();
            if (now - lastSubmit < 60000) { // 60 seconds rate limit
                rateLimitMessage.classList.remove('d-none');
                setTimeout(() => rateLimitMessage.classList.add('d-none'), 5000);
                return;
            }

            const entryText = entryTextarea.value.trim();
            if (entryText === '') {
                return;
            }
            
            const entryId = form.querySelector('#entryId').value;
            await saveEntry(entryText, entryId);
            
            // Clear form
            entryTextarea.value = '';
            form.querySelector('#entryId').value = '';
            selectedEmotion = null;
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));
            emotionPrompt.textContent = 'Elige una emoci√≥n para tu entrada...';
            writingMessage.classList.add('d-none');
            
            lastSubmit = now;
        });

    </script>
</body>
</html>
